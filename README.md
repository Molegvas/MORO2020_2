Проект MORO2020_2
pcb:      v43 
display:  TFT 1.8"  
date:     Февраль 2020

            Особенности реализации

*** Среда разработки - PlatformIO. Включена поддержка платформы Arduino для ESP32.

*** Поддержка Arduino автоматически предполагает, что программа будет работать в среде Free RTOS, хотя многое, как это характерно для Ардуино, скрыто. Так что философию операционной системы реального времени (RTOS) постичь придется, но вникать в тонкости... как говорится, "всё уже сделано за нас".

*** Разбивка на задачи производится в mail.cpp. Задач всего на данный момент пять.
Производится выделение ресурсов для каждой задачи: память, приоритет, ядро.
Все наши задачи исполняются ядром 1, ядро 0 выделено для радиочастотных задач - BT и WiFi.
Учтите, что setup() выполнялся без обязательных требований по максимальному времени монопольного захвата ядра (13мс). Включение RTOS произойдет только после loop() {}. Цикл пустой, но может быть заполнен фоновой программой, которая автоматически будет оформлена в виде одной из задач по умолчанию.

*** Коротко конкретно по каждой задаче:

Задача подключения к WiFi сети (полностью заимствована как есть) Период 10мс. Длительность 2-3мс.

Задача выдачи данных на дисплей (5 параметров, дисплей TFT 1.8") 250мс, 25мс.

Задача управления системой теплоотвода. Предполагается расширить функциональность, добавив 
слежение за правильностью подключения нагрузки, масштабирование тока и т.д. Менее 1мс, 0,2с

Задача обслуживает выбор режима работы, она же управляет конечным автоматом выбранного режима вплоть до выхода из режима. И то и другое построены как конечные автоматы (FSM). Особенностью этой задачи является то, что она запускается не в порядке очереди задач, а по таймеру исключительно для того, чтобы измерять точно ампер-часы. 100мс, 100мс.

Задача управления измерениями напряжения с выбором диапазона, тока, температуры, 
напряжения с кнопок - всё с фильтрацией, линеаризацией и преобразованием в 
физические величины. 0,03мс, 10мс. 

***     По большому счету для обмена данными между задачами должны бы использоваться 
конвееры и семафоры... Однако довольно длительное тестирование показало, что
разработчики учли нечто такое... атомарность, транзакции ...
Впрочем, в проекте нет глобальных переменных.  Как-то так.

***     О реализации конечных автоматов (SM, FSM). 
Они в проекте повсюду. Вдохновение почерпнуто из статьи Павла Бобкова:
https://chipenable.ru/index.php/programming-avr/item/90-realizatsiya-konechnogo-avtomata-state-machine.html
Однако реализация построена на виртуальных методах. Выгода очевидна - произвольное 
размещение классов, описывающих состояния, простая структура класса любого состояния, 
прозрачная проверка условий и переходов, хорошая самодокументированность. Но постичь философию конечных автоматов, не вникая в тонкости, придется.

***     Более-менее законченный вид имеет диспетчер выбора режима (mdispatcherfsm.h,.cpp) и
режим простого заряда (mcccvfsm.h,.cpp). Остальные пока не приведены к окончательному
виду, а потому как учебное пособие использоваться не могут. 

***     Между режимами нет никакой связи - что позволяет разрабатывать каждый в отдельности, 
сосредотачиваясь исключительно на одном из них. Некоторая избыточность при этом - 
небольшая плата. Реализация режима занимает в програмной памяти несколько десятых долей
процента, проверено. Предполагается, что конечный пользователь, имея некоторый навык (...) сможет, используя шаблон режима, создать режим имени себя любимого без особого риска преобразования прибора в "кирпич". 

***     Общим ресурсом всех режимов является класс MTools, в котором определен довольно широкий
инструментарий для построения пользовательских режимов. Пока там много ненужного, чистка 
и оптимизация предполагаются. Предполагается, что Tools для редактирования будет доступен только разработчику прибора. 

***     Вывода на дисплей пока нет - закомментированные //Oled->xxx(); методы предназначались
для работы с OLED 1.56" 128*64. Проект MORO2020_2 предполагает использование TFT 1.8"
128*160 RGB дисплея. Структура вывода на экран пока окончательно не определена.   

